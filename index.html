<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>æˆ‘çš„æ¯›çº¿ä»“åº“ - ä¸ªäººæ¯›çº¿ç®¡ç†</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- SheetJS (Excelå¤„ç†) -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- æ ¸å¿ƒä¿®å¤ï¼šå®šä¹‰é»˜è®¤å˜é‡ï¼ˆFallbackï¼‰--- */
        :root {
            --primary: #fb7185;
            --bg-light: #fff1f2;
            --text-theme: #881337;
        }

        /* åŸºç¡€æ ·å¼ */
        body { 
            margin: 0; padding: 0; 
            background-color: #e5e7eb; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* ç§»åŠ¨ç«¯å®¹å™¨ */
        .mobile-container {
            max-width: 480px;
            margin: 0 auto;
            height: 100vh; /* Fallback */
            height: 100dvh; 
            background-color: #f9fafb;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            position: relative;
            display: flex;
            flex-direction: column;
        }

        /* æ»šåŠ¨æ¡éšè— */
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .image-preview {
            width: 100%; height: 200px; object-fit: cover;
            border-radius: 12px; background-color: #e5e7eb;
        }

        /* å¼ºåˆ¶è¦†ç›–æ ·å¼çš„å·¥å…·ç±» - è¿™é‡Œçš„ !important ç¡®ä¿ä¼˜å…ˆçº§ */
        .bg-theme { background-color: var(--primary) !important; }
        .bg-theme-light { background-color: var(--bg-light) !important; }
        .text-theme { color: var(--text-theme) !important; }
        .border-theme { border-color: var(--primary) !important; }
        
        /* iOS é€‚é… */
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .pt-safe { padding-top: max(1rem, env(safe-area-inset-top)); }
        
        .modal-mask {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 50;
            display: flex; align-items: center; justify-content: center;
        }
    </style>
</head>
<body>

<div id="app" class="h-full text-gray-700">
    <div class="mobile-container">
        
        <!-- å¤´éƒ¨ -->
        <header class="bg-theme text-white pt-safe px-4 pb-3 shadow-lg z-20 flex-shrink-0 transition-colors duration-300">
            <div class="flex justify-between items-center relative h-10">
                <button v-if="currentPage !== 'home' && currentPage !== 'settings'" @click="goBack" class="w-8 h-8 flex items-center justify-center active:opacity-70">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <div v-else class="w-8"></div> 

                <h1 class="text-lg font-bold absolute left-1/2 transform -translate-x-1/2 whitespace-nowrap">
                    {{ pageTitle }}
                </h1>

                <!-- é¡¶éƒ¨å³ä¾§æŒ‰é’® -->
                <button v-if="currentPage === 'form'" @click="saveYarn" class="font-bold text-sm bg-white/20 px-3 py-1 rounded-full">ä¿å­˜</button>
                <button v-else-if="currentPage === 'detail'" @click="editYarn(selectedYarn)" class="w-8 h-8"><i class="fas fa-edit"></i></button>
                <div v-else class="w-8"></div>
            </div>
        </header>

        <!-- ä¸»å†…å®¹ -->
        <main class="flex-1 overflow-y-auto hide-scrollbar p-4 pb-24">
            
            <!-- 1. ä¸»é¡µ -->
            <div v-if="currentPage === 'home'" class="space-y-4">
                <!-- ç»Ÿè®¡å¡ç‰‡ -->
                <div class="bg-white rounded-2xl p-5 shadow-sm border border-gray-100 grid grid-cols-2 gap-4">
                    <div>
                        <div class="text-xs text-gray-400 mb-1">åº“å­˜æ€»é‡</div>
                        <div class="text-2xl font-bold text-gray-800">{{ (totalWeight / 500).toFixed(1) }} <span class="text-sm font-normal text-gray-500">æ–¤</span></div>
                    </div>
                    <div>
                        <div class="text-xs text-gray-400 mb-1">æ€»èŠ±è´¹</div>
                        <div class="text-2xl font-bold text-gray-800">Â¥{{ totalCost }}</div>
                    </div>
                    <div class="col-span-2 border-t border-gray-100 pt-3 flex justify-between text-sm">
                        <span class="text-gray-500">æ•°é‡: <b class="text-gray-800">{{ yarns.length }}</b> å›¢</span>
                        <span class="text-gray-500">å·²ç”¨: <b class="text-gray-800">{{ (totalConsumed / 500).toFixed(1) }}</b> æ–¤</span>
                    </div>
                </div>

                <!-- ç­›é€‰æ’åº -->
                <div class="flex items-center gap-3 overflow-x-auto pb-2 hide-scrollbar">
                    <button @click="filterType = 'all'" 
                        class="flex-shrink-0 px-4 py-1.5 rounded-full text-sm font-medium transition-colors"
                        :class="filterType === 'all' ? 'bg-theme text-white shadow-md' : 'bg-white text-gray-600 border border-gray-200'">
                        å…¨éƒ¨
                    </button>
                    <button @click="filterType = 'fav'" 
                        class="flex-shrink-0 px-4 py-1.5 rounded-full text-sm font-medium transition-colors"
                        :class="filterType === 'fav' ? 'bg-theme text-white shadow-md' : 'bg-white text-gray-600 border border-gray-200'">
                        æ”¶è— <i class="fas fa-heart text-xs ml-1" :class="filterType==='fav'?'text-white':'text-red-400'"></i>
                    </button>
                    <div class="w-px h-6 bg-gray-300 flex-shrink-0 mx-1"></div>
                    <select v-model="sortBy" class="flex-shrink-0 px-3 py-1.5 rounded-full text-sm border border-gray-200 bg-white text-gray-600 outline-none">
                        <option value="dateDesc">æœ€æ–°æ·»åŠ </option>
                        <option value="priceDesc">å•ä»·(é«˜åˆ°ä½)</option>
                        <option value="weightDesc">å‰©ä½™é‡é‡(å¤šåˆ°å°‘)</option>
                        <option value="brand">æŒ‰å“ç‰Œ</option>
                    </select>
                </div>

                <!-- åˆ—è¡¨ -->
                <div class="space-y-3">
                    <div v-if="filteredYarns.length === 0" class="text-center py-20 opacity-50">
                        <i class="fas fa-box-open text-5xl mb-3 text-gray-300"></i>
                        <p class="text-gray-500">ä»“åº“ç©ºç©ºå¦‚ä¹Ÿï¼Œç‚¹å³ä¸‹è§’æ·»åŠ </p>
                    </div>

                    <div v-for="yarn in filteredYarns" :key="yarn.id" @click="viewDetail(yarn)" 
                        class="bg-white rounded-xl p-3 shadow-sm active:scale-[0.98] transition-transform duration-100 flex gap-3 border border-gray-100">
                        <div class="w-24 h-24 bg-gray-100 rounded-lg flex-shrink-0 overflow-hidden relative">
                            <img v-if="yarn.image" :src="yarn.image" class="w-full h-full object-cover">
                            <div v-else class="w-full h-full flex items-center justify-center text-gray-300">
                                <i class="fas fa-image text-xl"></i>
                            </div>
                            <div v-if="yarn.isFavorite" class="absolute top-1 right-1 bg-white/80 rounded-full w-5 h-5 flex items-center justify-center">
                                <i class="fas fa-heart text-red-500 text-xs"></i>
                            </div>
                        </div>
                        <div class="flex-1 flex flex-col justify-between py-0.5">
                            <div>
                                <h3 class="font-bold text-gray-800 text-base truncate">{{ yarn.name }}</h3>
                                <p class="text-xs text-gray-500 mt-1 line-clamp-1">{{ yarn.brand }} | {{ yarn.composition }}</p>
                            </div>
                            <div class="flex justify-between items-end">
                                <div>
                                    <div class="text-xs text-gray-400">ä½™é‡</div>
                                    <div class="text-sm font-bold text-theme">{{ yarn.weight - (yarn.consumed || 0) }}g</div>
                                </div>
                                <div class="text-right">
                                    <span class="text-xs bg-gray-100 text-gray-600 px-1.5 py-0.5 rounded">
                                        Â¥{{ (yarn.price / (yarn.weight/500)).toFixed(0) }}/æ–¤
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2. ç¼–è¾‘/æ·»åŠ  -->
            <div v-if="currentPage === 'form'" class="space-y-5">
                <div class="bg-white p-4 rounded-xl shadow-sm">
                    <div class="relative" @click="$refs.fileInput.click()">
                        <img v-if="formData.image" :src="formData.image" class="image-preview border-2 border-dashed border-theme">
                        <div v-else class="image-preview border-2 border-dashed border-gray-300 flex flex-col items-center justify-center text-gray-400 bg-gray-50">
                            <i class="fas fa-camera text-3xl mb-2"></i>
                            <span class="text-sm">ç‚¹å‡»æ‹æ‘„/ä¸Šä¼ ç…§ç‰‡</span>
                        </div>
                        <input type="file" ref="fileInput" accept="image/*" class="hidden" @change="handleImageUpload">
                    </div>
                </div>

                <div class="bg-white p-5 rounded-xl shadow-sm space-y-4">
                    <div>
                        <label class="text-xs font-bold text-gray-500 uppercase">æ¯›çº¿åç§° <span class="text-red-500">*</span></label>
                        <input v-model="formData.name" type="text" class="w-full mt-1 p-2 bg-gray-50 border-b-2 border-transparent focus:border-theme outline-none transition-colors" placeholder="è¾“å…¥åç§°">
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-xs font-bold text-gray-500">å“ç‰Œ</label>
                            <input v-model="formData.brand" list="list_brands" class="w-full mt-1 p-2 bg-gray-50 rounded" placeholder="é€‰æ‹©æˆ–è¾“å…¥">
                            <datalist id="list_brands"><option v-for="opt in options.brands" :value="opt"></datalist>
                        </div>
                        <div>
                            <label class="text-xs font-bold text-gray-500">é¢œè‰²</label>
                            <input v-model="formData.color" list="list_colors" class="w-full mt-1 p-2 bg-gray-50 rounded" placeholder="é€‰æ‹©æˆ–è¾“å…¥">
                            <datalist id="list_colors"><option v-for="opt in options.colors" :value="opt"></datalist>
                        </div>
                    </div>

                    <div>
                        <label class="text-xs font-bold text-gray-500">æˆåˆ† <span class="text-red-500">*</span></label>
                        <div class="flex gap-2 mt-1">
                            <select @change="appendMaterial($event)" class="w-24 p-2 bg-gray-50 rounded text-sm outline-none">
                                <option value="">+ æ·»åŠ </option>
                                <option v-for="opt in options.materials" :value="opt">{{opt}}</option>
                            </select>
                            <input v-model="formData.composition" type="text" class="flex-1 p-2 bg-gray-50 rounded" placeholder="å¦‚: 80%ç¾Šæ¯›">
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-xs font-bold text-gray-500">æ€»é‡é‡ (g) <span class="text-red-500">*</span></label>
                            <input v-model.number="formData.weight" type="number" class="w-full mt-1 p-2 bg-gray-50 rounded font-mono">
                        </div>
                        <div>
                            <label class="text-xs font-bold text-gray-500">æ€»ä»·æ ¼ (å…ƒ) <span class="text-red-500">*</span></label>
                            <input v-model.number="formData.price" type="number" class="w-full mt-1 p-2 bg-gray-50 rounded font-mono">
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-xs font-bold text-gray-500">æ”¯æ•°</label>
                            <input v-model="formData.ply" list="list_plies" class="w-full mt-1 p-2 bg-gray-50 rounded" placeholder="å¦‚ 2/26">
                            <datalist id="list_plies"><option v-for="opt in options.plies" :value="opt"></datalist>
                        </div>
                        <div>
                            <label class="text-xs font-bold text-gray-500">æ¥æº</label>
                            <input v-model="formData.source" list="list_sources" class="w-full mt-1 p-2 bg-gray-50 rounded">
                            <datalist id="list_sources"><option v-for="opt in options.sources" :value="opt"></datalist>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-xs font-bold text-gray-500">è´­ä¹°æ—¶é—´</label>
                            <input v-model="formData.buyDate" type="date" class="w-full mt-1 p-2 bg-gray-50 rounded text-sm">
                        </div>
                        <div>
                            <label class="text-xs font-bold text-gray-500">å·²æ¶ˆè€— (g)</label>
                            <input v-model.number="formData.consumed" type="number" class="w-full mt-1 p-2 bg-gray-50 rounded font-mono">
                        </div>
                    </div>

                    <div class="bg-theme-light p-3 rounded-lg flex items-center gap-2 text-theme text-sm">
                        <i class="fas fa-calculator"></i>
                        <span>æŠ˜åˆå•ä»·ï¼š<b>Â¥{{ computedUnitPrice }}</b> / æ–¤</span>
                    </div>
                </div>
            </div>

            <!-- 3. è¯¦æƒ…é¡µ -->
            <div v-if="currentPage === 'detail' && selectedYarn" class="space-y-4">
                <div class="relative">
                    <img v-if="selectedYarn.image" :src="selectedYarn.image" class="w-full h-72 object-cover rounded-2xl shadow-sm">
                    <div v-else class="w-full h-40 bg-gray-200 rounded-2xl flex items-center justify-center text-gray-400">æ— å›¾ç‰‡</div>
                    
                    <button @click="toggleFavorite(selectedYarn)" class="absolute bottom-[-20px] right-6 w-12 h-12 bg-white rounded-full shadow-lg flex items-center justify-center text-xl z-10">
                        <i :class="['fas fa-heart', selectedYarn.isFavorite ? 'text-red-500' : 'text-gray-300']"></i>
                    </button>
                </div>

                <div class="bg-white pt-8 pb-6 px-6 rounded-2xl shadow-sm mt-[-30px] relative z-0">
                    <h2 class="text-2xl font-bold text-gray-800">{{ selectedYarn.name }}</h2>
                    <p class="text-sm text-gray-500 mt-1">{{ selectedYarn.composition }}</p>

                    <div class="flex items-center gap-4 mt-4 mb-6">
                        <div class="flex-1 bg-gray-50 p-3 rounded-xl text-center">
                            <div class="text-xs text-gray-400">å‰©ä½™é‡é‡</div>
                            <div class="text-xl font-bold text-theme">{{ selectedYarn.weight - (selectedYarn.consumed || 0) }}g</div>
                        </div>
                        <div class="flex-1 bg-gray-50 p-3 rounded-xl text-center">
                            <div class="text-xs text-gray-400">å•ä»·</div>
                            <div class="text-xl font-bold text-gray-700">Â¥{{ (selectedYarn.price / (selectedYarn.weight/500)).toFixed(0) }}</div>
                        </div>
                    </div>

                    <div class="space-y-3 text-sm">
                        <div class="flex border-b border-gray-100 pb-2">
                            <span class="text-gray-400 w-20">å“ç‰Œ</span><span class="text-gray-800">{{ selectedYarn.brand || 'æœªè®°å½•' }}</span>
                        </div>
                        <div class="flex border-b border-gray-100 pb-2">
                            <span class="text-gray-400 w-20">é¢œè‰²</span><span class="text-gray-800">{{ selectedYarn.color || 'æœªè®°å½•' }}</span>
                        </div>
                        <div class="flex border-b border-gray-100 pb-2">
                            <span class="text-gray-400 w-20">æ”¯æ•°</span><span class="text-gray-800">{{ selectedYarn.ply || 'æœªè®°å½•' }}</span>
                        </div>
                        <div class="flex border-b border-gray-100 pb-2">
                            <span class="text-gray-400 w-20">æ¥æº</span><span class="text-gray-800">{{ selectedYarn.source || 'æœªè®°å½•' }}</span>
                        </div>
                        <div class="flex border-b border-gray-100 pb-2">
                            <span class="text-gray-400 w-20">è´­å…¥æ—¥æœŸ</span><span class="text-gray-800">{{ selectedYarn.buyDate || 'æœªè®°å½•' }}</span>
                        </div>
                    </div>
                </div>

                <button @click="confirmDelete(selectedYarn)" class="w-full py-3 text-red-500 bg-white border border-red-100 rounded-xl font-bold active:bg-red-50">
                    <i class="fas fa-trash-alt mr-2"></i> åˆ é™¤æ­¤è®°å½•
                </button>
            </div>

            <!-- 4. è®¾ç½®é¡µé¢ -->
            <div v-if="currentPage === 'settings'" class="space-y-5">
                <!-- ä¸»é¢˜ -->
                <div class="bg-white p-5 rounded-xl shadow-sm">
                    <h3 class="font-bold text-gray-700 mb-4 flex items-center">
                        <i class="fas fa-palette mr-2 text-theme"></i> ä¸»é¢˜é¢œè‰²
                    </h3>
                    <div class="flex justify-between px-2">
                        <button v-for="c in ['pink','blue','purple','orange','gray']" :key="c"
                            @click="theme = c"
                            class="w-10 h-10 rounded-full ring-2 ring-offset-2 transition-all"
                            :style="{backgroundColor: themeMap[c].primary}"
                            :class="theme===c?'ring-gray-400 scale-110':'ring-transparent'">
                        </button>
                    </div>
                </div>

                <!-- é€‰é¡¹ç®¡ç† -->
                <div class="bg-white p-5 rounded-xl shadow-sm">
                    <h3 class="font-bold text-gray-700 mb-4 flex items-center">
                        <i class="fas fa-list-ul mr-2 text-theme"></i> ä¸‹æ‹‰é€‰é¡¹ç®¡ç†
                    </h3>
                    <div class="space-y-3">
                        <button @click="openOptionManager('brands', 'å“ç‰Œ')" class="w-full flex justify-between items-center p-3 bg-gray-50 rounded-lg hover:bg-gray-100">
                            <span>ğŸ§¶ å“ç‰Œç®¡ç†</span> <i class="fas fa-chevron-right text-gray-400"></i>
                        </button>
                        <button @click="openOptionManager('materials', 'æˆåˆ†')" class="w-full flex justify-between items-center p-3 bg-gray-50 rounded-lg hover:bg-gray-100">
                            <span>ğŸ‘ æˆåˆ†ç®¡ç†</span> <i class="fas fa-chevron-right text-gray-400"></i>
                        </button>
                        <button @click="openOptionManager('colors', 'é¢œè‰²')" class="w-full flex justify-between items-center p-3 bg-gray-50 rounded-lg hover:bg-gray-100">
                            <span>ğŸ¨ é¢œè‰²ç®¡ç†</span> <i class="fas fa-chevron-right text-gray-400"></i>
                        </button>
                        <button @click="openOptionManager('plies', 'æ”¯æ•°')" class="w-full flex justify-between items-center p-3 bg-gray-50 rounded-lg hover:bg-gray-100">
                            <span>ğŸ“ æ”¯æ•°ç®¡ç†</span> <i class="fas fa-chevron-right text-gray-400"></i>
                        </button>
                        <button @click="openOptionManager('sources', 'æ¥æº')" class="w-full flex justify-between items-center p-3 bg-gray-50 rounded-lg hover:bg-gray-100">
                            <span>ğŸª æ¥æºç®¡ç†</span> <i class="fas fa-chevron-right text-gray-400"></i>
                        </button>
                    </div>
                </div>

                <!-- å¤‡ä»½ -->
                <div class="bg-white p-5 rounded-xl shadow-sm">
                    <h3 class="font-bold text-gray-700 mb-4 flex items-center">
                        <i class="fas fa-database mr-2 text-theme"></i> æ•°æ®å¤‡ä»½
                    </h3>
                    <div class="flex gap-3">
                        <button @click="exportExcel" class="flex-1 bg-green-500 active:bg-green-600 text-white py-3 rounded-xl flex items-center justify-center gap-2 shadow-sm">
                            <i class="fas fa-file-export"></i> å¯¼å‡º
                        </button>
                        <div class="flex-1 relative">
                             <button class="w-full bg-blue-500 active:bg-blue-600 text-white py-3 rounded-xl flex items-center justify-center gap-2 shadow-sm">
                                <i class="fas fa-file-import"></i> å¯¼å…¥
                             </button>
                             <input type="file" @change="importExcel" accept=".xlsx, .xls" class="absolute top-0 left-0 w-full h-full opacity-0 cursor-pointer">
                        </div>
                    </div>
                </div>
                
                <div class="text-center text-gray-400 text-xs pt-4">
                    æˆ‘çš„æ¯›çº¿ä»“åº“ v1.3
                </div>
            </div>
        </main>

        <!-- æ‚¬æµ®æŒ‰é’® -->
        <button v-if="currentPage === 'home'" @click="openAddForm" 
            class="fixed bottom-24 right-6 w-14 h-14 bg-theme text-white rounded-full shadow-lg shadow-gray-400/50 flex items-center justify-center text-2xl z-30 transition-transform active:scale-95">
            <i class="fas fa-plus"></i>
        </button>

        <!-- åº•éƒ¨å¯¼èˆª -->
        <nav class="absolute bottom-0 w-full bg-white border-t border-gray-200 h-16 flex z-40 pb-safe">
            <button @click="currentPage = 'home'" class="flex-1 flex flex-col items-center justify-center gap-1 transition-colors" :class="currentPage!=='settings' ? 'text-theme' : 'text-gray-400'">
                <i class="fas fa-home text-xl"></i>
                <span class="text-xs font-medium">ä»“åº“</span>
            </button>
            <button @click="currentPage = 'settings'" class="flex-1 flex flex-col items-center justify-center gap-1 transition-colors" :class="currentPage==='settings' ? 'text-theme' : 'text-gray-400'">
                <i class="fas fa-cog text-xl"></i>
                <span class="text-xs font-medium">è®¾ç½®</span>
            </button>
        </nav>

        <!-- æ¨¡æ€æ¡†ï¼šé€‰é¡¹ç®¡ç† -->
        <div v-if="showOptionModal" class="modal-mask" @click.self="showOptionModal = false">
            <div class="bg-white w-4/5 max-w-sm rounded-xl p-5 shadow-2xl">
                <div class="flex justify-between items-center mb-4 border-b pb-2">
                    <h3 class="font-bold text-gray-800">ç®¡ç†ï¼š{{ editingOptionTitle }}</h3>
                    <button @click="showOptionModal = false" class="text-gray-400"><i class="fas fa-times"></i></button>
                </div>
                
                <div class="flex gap-2 mb-4">
                    <input v-model="newOptionInput" type="text" class="flex-1 border rounded p-2 text-sm" placeholder="è¾“å…¥æ–°é€‰é¡¹">
                    <button @click="addOption" class="bg-theme text-white px-4 rounded text-sm">æ·»åŠ </button>
                </div>

                <div class="max-h-60 overflow-y-auto space-y-2 pr-1">
                    <div v-for="(item, index) in options[editingOptionKey]" :key="index" class="flex justify-between items-center bg-gray-50 p-2 rounded text-sm group">
                        <span>{{ item }}</span>
                        <button @click="removeOption(index)" class="text-gray-300 hover:text-red-500"><i class="fas fa-trash-alt"></i></button>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<script>
    const { createApp, ref, computed, reactive, watch, onMounted } = Vue;

    createApp({
        setup() {
            // --- ä¿®å¤ä¸»é¢˜ï¼šé€šè¿‡ JS ç›´æ¥æ“ä½œ Root CSS å˜é‡ ---
            const theme = ref(localStorage.getItem('coil_theme') || 'pink');
            
            const themeMap = {
                pink: { primary: '#fb7185', bgLight: '#fff1f2', text: '#881337' },
                blue: { primary: '#2dd4bf', bgLight: '#f0fdfa', text: '#134e4a' },
                purple: { primary: '#c084fc', bgLight: '#faf5ff', text: '#581c87' },
                gray: { primary: '#6b7280', bgLight: '#f3f4f6', text: '#111827' },
                orange: { primary: '#fbbf24', bgLight: '#fffbeb', text: '#78350f' }
            };

            // ç›‘å¬ theme å˜åŒ–ï¼Œç›´æ¥æ›´æ–° document æ ·å¼ï¼Œç¡®ä¿ä¸‡æ— ä¸€å¤±
            watch(theme, (newVal) => {
                const t = themeMap[newVal] || themeMap['pink'];
                document.documentElement.style.setProperty('--primary', t.primary);
                document.documentElement.style.setProperty('--bg-light', t.bgLight);
                document.documentElement.style.setProperty('--text-theme', t.text);
                localStorage.setItem('coil_theme', newVal);
            }, { immediate: true });

            // --- å…¶ä»–é€»è¾‘ä¿æŒä¸å˜ ---
            const currentPage = ref('home');
            const yarns = ref([]);
            
            const defaultOptions = {
                materials: ['ç¾Šæ¯›', 'ç¾Šç»’', 'è²‰ç»’', 'é©¬æµ·', 'åŒ–çº¤', 'çœŸä¸', 'è‹éº»', 'æ£‰', 'æ··çºº'],
                brands: ['è´è¶', 'å‡Œå‰', 'åº·èµ›å¦®', 'ä¸­é¼', 'æ–°å¥¥', 'æ¬§ç¾æ–¯', 'å—éŸ©'],
                plies: ['2/26', '2/28', '2/30', '1/4', '1/16', '1/15'],
                colors: ['çº¢', 'ç™½', 'è“', 'ç»¿', 'é»‘', 'ç´«', 'æ£•', 'å’–', 'ç°'],
                sources: ['ç™¾ç™¾', 'è€å¸¸', 'å‚»å°å­', 'æ„è¾¾']
            };
            const options = reactive(JSON.parse(localStorage.getItem('coil_options')) || defaultOptions);

            const filterType = ref('all');
            const sortBy = ref('dateDesc');
            const selectedYarn = ref(null);
            const isEditing = ref(false);

            const formData = reactive({
                id: null, name: '', image: '', brand: '', color: '', composition: '',
                weight: 500, price: 0, ply: '', source: '', buyDate: '', consumed: 0,
                isFavorite: false, createTime: 0
            });

            const showOptionModal = ref(false);
            const editingOptionKey = ref('');
            const editingOptionTitle = ref('');
            const newOptionInput = ref('');

            // --- è®¡ç®—å±æ€§ ---
            const pageTitle = computed(() => {
                const titles = { home: 'æˆ‘çš„æ¯›çº¿ä»“åº“', settings: 'è®¾ç½®', form: isEditing.value ? 'ç¼–è¾‘è®°å½•' : 'å…¥åº“ç™»è®°', detail: 'è¯¦æƒ…' };
                return titles[currentPage.value];
            });

            const totalCost = computed(() => yarns.value.reduce((sum, y) => sum + (y.price || 0), 0));
            const totalWeight = computed(() => yarns.value.reduce((sum, y) => sum + (y.weight || 0), 0));
            const totalConsumed = computed(() => yarns.value.reduce((sum, y) => sum + (y.consumed || 0), 0));
            
            const computedUnitPrice = computed(() => {
                if(!formData.weight || formData.weight === 0) return 0;
                return (formData.price / (formData.weight / 500)).toFixed(1);
            });

            const filteredYarns = computed(() => {
                let list = [...yarns.value];
                if (filterType.value === 'fav') list = list.filter(y => y.isFavorite);
                list.sort((a, b) => {
                    if (sortBy.value === 'dateDesc') return b.createTime - a.createTime;
                    if (sortBy.value === 'priceDesc') return (b.price/b.weight) - (a.price/a.weight);
                    if (sortBy.value === 'weightDesc') return (b.weight - (b.consumed||0)) - (a.weight - (a.consumed||0));
                    if (sortBy.value === 'brand') return (a.brand || '').localeCompare(b.brand || '');
                    return 0;
                });
                return list;
            });

            // --- æ–¹æ³• ---
            onMounted(() => {
                const savedYarns = localStorage.getItem('coil_yarns');
                if (savedYarns) yarns.value = JSON.parse(savedYarns);
                for(let key in defaultOptions){
                    if(!options[key]) options[key] = defaultOptions[key];
                }
            });

            watch(yarns, () => localStorage.setItem('coil_yarns', JSON.stringify(yarns.value)), { deep: true });
            watch(options, () => localStorage.setItem('coil_options', JSON.stringify(options)), { deep: true });

            const goBack = () => currentPage.value = 'home';
            
            const openOptionManager = (key, title) => {
                editingOptionKey.value = key;
                editingOptionTitle.value = title;
                newOptionInput.value = '';
                showOptionModal.value = true;
            };
            const addOption = () => {
                const val = newOptionInput.value.trim();
                if(val && !options[editingOptionKey.value].includes(val)) {
                    options[editingOptionKey.value].push(val);
                    newOptionInput.value = '';
                }
            };
            const removeOption = (idx) => {
                if(confirm('åˆ é™¤æ­¤é€‰é¡¹ï¼Ÿ')) options[editingOptionKey.value].splice(idx, 1);
            };

            const handleImageUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (evt) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const maxWidth = 600; 
                        const scale = maxWidth / img.width;
                        canvas.width = maxWidth;
                        canvas.height = img.height * scale;
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        formData.image = canvas.toDataURL('image/jpeg', 0.65);
                    };
                    img.src = evt.target.result;
                };
                reader.readAsDataURL(file);
            };

            const openAddForm = () => {
                isEditing.value = false;
                Object.keys(formData).forEach(k => formData[k] = (k==='weight'?500:k==='price'?0:k==='consumed'?0:k==='isFavorite'?false:''));
                formData.buyDate = new Date().toISOString().split('T')[0];
                currentPage.value = 'form';
            };

            const editYarn = (yarn) => {
                isEditing.value = true;
                Object.assign(formData, JSON.parse(JSON.stringify(yarn)));
                currentPage.value = 'form';
            };

            const appendMaterial = (e) => {
                if(e.target.value) {
                    formData.composition = formData.composition ? `${formData.composition} + ${e.target.value}` : e.target.value;
                    e.target.value = "";
                }
            };

            const saveYarn = () => {
                if (!formData.name || !formData.weight) return alert('è¯·å¡«å†™åç§°å’Œé‡é‡');
                const data = { ...formData };
                if (isEditing.value) {
                    const idx = yarns.value.findIndex(y => y.id === formData.id);
                    if (idx !== -1) {
                        yarns.value[idx] = data;
                        selectedYarn.value = data;
                        currentPage.value = 'detail';
                    }
                } else {
                    data.id = Date.now().toString(36) + Math.random().toString(36).substr(2);
                    data.createTime = Date.now();
                    yarns.value.unshift(data);
                    currentPage.value = 'home';
                }
            };

            const viewDetail = (y) => { selectedYarn.value = y; currentPage.value = 'detail'; };
            const toggleFavorite = (y) => y.isFavorite = !y.isFavorite;
            const confirmDelete = (y) => {
                if (confirm('ç¡®å®šåˆ é™¤å—ï¼Ÿ')) {
                    yarns.value = yarns.value.filter(item => item.id !== y.id);
                    currentPage.value = 'home';
                }
            };

            const exportExcel = () => {
                const data = yarns.value.map(y => ({
                    'ç¼–å·(å‹¿æ”¹)': y.id, 'åç§°': y.name, 'å“ç‰Œ': y.brand, 'æˆåˆ†': y.composition,
                    'é¢œè‰²': y.color, 'æ€»é‡é‡(g)': y.weight, 'æ€»ä»·æ ¼': y.price, 'æ”¯æ•°': y.ply,
                    'æ¥æº': y.source, 'è´­ä¹°æ—¶é—´': y.buyDate, 'å·²æ¶ˆè€—(g)': y.consumed
                }));
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(data), "åº“å­˜");
                XLSX.writeFile(wb, "æ¯›çº¿åº“å­˜å¤‡ä»½.xlsx");
            };

            const importExcel = (e) => {
                const file = e.target.files[0];
                if(!file) return;
                const reader = new FileReader();
                reader.onload = (evt) => {
                    const wb = XLSX.read(new Uint8Array(evt.target.result), {type: 'array'});
                    const jsonData = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                    let added = 0, updated = 0;
                    jsonData.forEach(row => {
                        const id = row['ç¼–å·(å‹¿æ”¹)'];
                        const item = {
                            id: id || Date.now().toString(36) + Math.random().toString(36).substr(2),
                            name: row['åç§°'], brand: row['å“ç‰Œ']||'', composition: row['æˆåˆ†']||'',
                            color: row['é¢œè‰²']||'', weight: Number(row['æ€»é‡é‡(g)'])||0,
                            price: Number(row['æ€»ä»·æ ¼'])||0, ply: row['æ”¯æ•°']||'',
                            source: row['æ¥æº']||'', buyDate: row['è´­ä¹°æ—¶é—´']||'',
                            consumed: Number(row['å·²æ¶ˆè€—(g)'])||0,
                            image: '', isFavorite: false, createTime: Date.now()
                        };
                        const existIdx = yarns.value.findIndex(y => y.id === id);
                        if(existIdx > -1) {
                            yarns.value[existIdx] = { ...yarns.value[existIdx], ...item, image: yarns.value[existIdx].image, isFavorite: yarns.value[existIdx].isFavorite };
                            updated++;
                        } else {
                            yarns.value.unshift(item);
                            added++;
                        }
                    });
                    alert(`å¯¼å…¥æˆåŠŸï¼šæ–°å¢ ${added}, æ›´æ–° ${updated}`);
                    e.target.value = '';
                };
                reader.readAsArrayBuffer(file);
            };

            return {
                currentPage, theme, yarns, filterType, sortBy, selectedYarn, formData, options,
                showOptionModal, editingOptionTitle, editingOptionKey, newOptionInput,
                themeMap, pageTitle, totalCost, totalWeight, totalConsumed, filteredYarns, computedUnitPrice, isEditing,
                goBack, openAddForm, editYarn, saveYarn, handleImageUpload, appendMaterial,
                viewDetail, toggleFavorite, confirmDelete, exportExcel, importExcel,
                openOptionManager, addOption, removeOption
            };
        }
    }).mount('#app');
</script>
</body>
</html>
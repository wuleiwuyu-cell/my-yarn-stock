<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="æ¯›çº¿ä»“åº“">
    <title>æˆ‘çš„æ¯›çº¿ä»“åº“ - ä¸ªäººæ¯›çº¿ç®¡ç†</title>

    <link rel="apple-touch-icon" href="icon.png" >

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- LocalForage (å…³é”®æ›´æ–°ï¼šç”¨äºè§£å†³å¤§æ–‡ä»¶å­˜å‚¨å¡é¡¿é—®é¢˜) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>
    
    <style>
        /* --- æ ¸å¿ƒå˜é‡ --- */
        :root { --primary: #fb7185; --bg-light: #fff1f2; --text-theme: #881337; }

        /* åŸºç¡€æ ·å¼ */
        body { 
            margin: 0; padding: 0; background-color: #e5e7eb; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            -webkit-tap-highlight-color: transparent; select { -webkit-appearance: none; }
        }
        
        .mobile-container {
            max-width: 480px; margin: 0 auto; min-height: 100vh;
            background-color: #f9fafb; box-shadow: 0 0 20px rgba(0,0,0,0.1);
            position: relative; display: flex; flex-direction: column;
        }

        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* å¼ºåˆ¶æ ·å¼ */
        .bg-theme { background-color: var(--primary) !important; }
        .text-theme { color: var(--text-theme) !important; }
        .text-primary { color: var(--primary) !important; }
        .border-theme { border-color: var(--primary) !important; }
        
        /* iOS é€‚é… */
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .pt-safe { padding-top: max(1rem, env(safe-area-inset-top)); }
        
        /* åº•éƒ¨å¯¼èˆªæ  */
        .nav-fixed {
            position: fixed; bottom: 0; left: 0; right: 0; 
            margin: 0 auto; max-width: 480px; 
            background-color: white; z-index: 50;
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        /* é®ç½©ä¸å¼¹çª— */
        .modal-mask {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 60;
            display: flex; align-items: center; justify-content: center;
        }

        /* åº•éƒ¨æŠ½å±‰æ ·å¼ (iOS Style Sheet) */
        .bottom-sheet-mask {
            position: fixed; inset: 0; z-index: 100; background: rgba(0,0,0,0.4);
            display: flex; flex-direction: column; justify-content: flex-end;
            backdrop-blur-sm;
        }
        .bottom-sheet-content {
            background: white; border-top-left-radius: 20px; border-top-right-radius: 20px;
            max-height: 70vh; display: flex; flex-direction: column;
            padding-bottom: env(safe-area-inset-bottom);
            animation: slideUp 0.3s ease-out;
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        .image-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .image-item { aspect-ratio: 1; border-radius: 8px; overflow: hidden; position: relative; background-color: #f3f4f6; border: 1px solid #e5e7eb; }
        .image-item img { width: 100%; height: 100%; object-fit: cover; }
        .delete-btn { position: absolute; top: 2px; right: 2px; background: rgba(0,0,0,0.5); color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 12px; }
        .main-tag { position: absolute; bottom: 0; left: 0; width: 100%; background: rgba(0,0,0,0.6); color: white; font-size: 10px; text-align: center; padding: 2px 0; }
        
        .spinner { border: 4px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top: 4px solid #ffffff; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        [v-cloak] { display: none; }
    </style>
</head>
<body>

<div id="app" class="h-full text-gray-700" v-cloak>
    <div class="mobile-container">
        
        <!-- å…¨å±€åŠ è½½é®ç½© -->
        <div v-if="isLoading" class="fixed inset-0 z-[100] bg-black/50 flex flex-col items-center justify-center text-white backdrop-blur-sm">
            <div class="spinner mb-4"></div>
            <p>{{ loadingText }}</p>
        </div>

        <!-- å¤´éƒ¨ -->
        <header class="bg-theme text-white pt-safe px-4 pb-3 shadow-lg z-20 flex-shrink-0 transition-colors duration-300 sticky top-0">
            <div class="flex justify-between items-center relative h-10">
                <button v-if="currentPage !== 'home' && currentPage !== 'settings'" @click="goBack" class="w-8 h-8 flex items-center justify-center active:opacity-70">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <div v-else class="w-8"></div> 

                <h1 class="text-lg font-bold absolute left-1/2 transform -translate-x-1/2 whitespace-nowrap">
                    {{ pageTitle }}
                </h1>

                <button v-if="currentPage === 'form'" @click="saveYarn" class="font-bold text-sm bg-white/20 px-3 py-1 rounded-full">ä¿å­˜</button>
                <button v-else-if="currentPage === 'detail'" @click="editYarn(selectedYarn)" class="w-8 h-8"><i class="fas fa-edit"></i></button>
                <div v-else class="w-8"></div>
            </div>
        </header>

        <!-- ä¸»å†…å®¹ -->
        <main class="flex-1 overflow-y-auto hide-scrollbar p-4 pb-28">
            
            <!-- 1. ä¸»é¡µ (åˆ—è¡¨) -->
            <div v-if="currentPage === 'home'" class="space-y-4">
                <div class="bg-white rounded-2xl p-4 shadow-sm border border-gray-100 grid grid-cols-2 gap-4">
                    <div>
                        <div class="text-xs text-gray-400 mb-1">åº“å­˜æ€»é‡</div>
                        <div class="text-2xl font-bold text-gray-800">{{ (totalWeight / 500).toFixed(1) }} <span class="text-sm font-normal text-gray-500">æ–¤</span></div>
                    </div>
                    <div>
                        <div class="text-xs text-gray-400 mb-1">æ€»èŠ±è´¹</div>
                        <div class="text-2xl font-bold text-gray-800">Â¥{{ totalCost }}</div>
                    </div>
                    <div class="col-span-2 border-t border-gray-100 pt-2 flex justify-between text-sm">
                        <span class="text-gray-500">æ•°é‡: <b>{{ yarns.length }}</b> å›¢</span>
                        <span class="text-gray-500">å·²ç”¨: <b>{{ (totalConsumed / 500).toFixed(1) }}</b> æ–¤</span>
                    </div>
                </div>

                <div class="flex items-center gap-3 overflow-x-auto pb-2 hide-scrollbar">
                    <button @click="filterType = 'all'" :class="filterType === 'all' ? 'bg-theme text-white shadow-md' : 'bg-white text-gray-600 border'" class="flex-shrink-0 px-4 py-1.5 rounded-full text-sm font-medium">å…¨éƒ¨</button>
                    <button @click="filterType = 'fav'" :class="filterType === 'fav' ? 'bg-theme text-white shadow-md' : 'bg-white text-gray-600 border'" class="flex-shrink-0 px-4 py-1.5 rounded-full text-sm font-medium">æ”¶è— â¤ï¸</button>
                    <div class="w-px h-6 bg-gray-300 flex-shrink-0 mx-1"></div>
                    <select v-model="sortBy" class="flex-shrink-0 px-3 py-1.5 rounded-full text-sm border border-gray-200 bg-white text-gray-600 outline-none">
                        <option value="dateDesc">æœ€æ–°æ·»åŠ </option>
                        <option value="priceDesc">å•ä»·(é«˜åˆ°ä½)</option>
                        <option value="weightDesc">ä½™é‡(å¤šåˆ°å°‘)</option>
                    </select>
                </div>

                <div class="space-y-3">
                    <div v-if="filteredYarns.length === 0" class="text-center py-20 opacity-50">
                        <i class="fas fa-box-open text-5xl mb-3 text-gray-300"></i>
                        <p class="text-gray-500">æš‚æ— æ•°æ®</p>
                    </div>

                    <div v-for="yarn in filteredYarns" :key="yarn.id" @click="viewDetail(yarn)" 
                        class="bg-white rounded-xl p-3 shadow-sm active:scale-[0.98] transition-transform duration-100 flex gap-3 border border-gray-100">
                        <div class="w-24 h-24 bg-gray-100 rounded-lg flex-shrink-0 overflow-hidden relative">
                            <!-- åˆ—è¡¨é¡µæ€§èƒ½ä¼˜åŒ–ï¼šå¦‚æœæœ‰å›¾ï¼Œæ˜¾ç¤ºç¬¬ä¸€å¼  -->
                            <img v-if="yarn.images && yarn.images.length > 0" :src="yarn.images[0]" loading="lazy" class="w-full h-full object-cover">
                            <div v-else class="w-full h-full flex items-center justify-center text-gray-300">
                                <i class="fas fa-image text-xl"></i>
                            </div>
                            <div v-if="yarn.images && yarn.images.length > 1" class="absolute bottom-1 right-1 bg-black/50 text-white text-[10px] px-1.5 rounded-sm backdrop-blur-sm">
                                +{{ yarn.images.length }}
                            </div>
                            <div v-if="yarn.isFavorite" class="absolute top-1 right-1 bg-white/90 rounded-full w-5 h-5 flex items-center justify-center shadow-sm">
                                <i class="fas fa-heart text-red-500 text-xs"></i>
                            </div>
                        </div>
                        <div class="flex-1 flex flex-col justify-between py-0.5">
                            <div>
                                <h3 class="font-bold text-gray-800 text-base truncate">{{ yarn.name }}</h3>
                                <p class="text-xs text-gray-500 mt-1 line-clamp-1">{{ yarn.brand }} | {{ yarn.composition }}</p>
                            </div>
                            <div class="flex justify-between items-end">
                                <div>
                                    <div class="text-xs text-gray-400">ä½™é‡</div>
                                    <div class="text-sm font-bold text-theme">{{ yarn.weight - (yarn.consumed || 0) }}g</div>
                                </div>
                                <div class="text-right">
                                    <span class="text-xs bg-gray-100 text-gray-600 px-1.5 py-0.5 rounded">
                                        Â¥{{ (yarn.price / (yarn.weight/500)).toFixed(0) }}/æ–¤
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2. ç¼–è¾‘/æ·»åŠ è¡¨å• -->
            <div v-if="currentPage === 'form'" class="space-y-5">
                <!-- å›¾ç‰‡åŒºåŸŸ -->
                <div class="bg-white p-4 rounded-xl shadow-sm">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-xs font-bold text-gray-500">ç…§ç‰‡ ({{formData.images.length}}å¼ )</span>
                        <span class="text-xs text-gray-400">ç¬¬ä¸€å¼ ä¸ºä¸»å›¾</span>
                    </div>
                    <div class="image-grid">
                        <div v-for="(img, idx) in formData.images" :key="idx" class="image-item">
                            <img :src="img">
                            <div class="delete-btn" @click.stop="removeImage(idx)"><i class="fas fa-times"></i></div>
                            <div v-if="idx === 0" class="main-tag">å°é¢</div>
                        </div>
                        <div class="image-item flex flex-col items-center justify-center bg-gray-50 text-gray-400 active:bg-gray-100" @click="$refs.fileInput.click()">
                            <i class="fas fa-camera text-xl mb-1"></i><span class="text-xs">æ·»åŠ </span>
                        </div>
                    </div>
                    <input type="file" ref="fileInput" accept="image/*" multiple class="hidden" @change="handleImageUpload">
                </div>

                <!-- æ ¸å¿ƒè¡¨å•åŒºåŸŸ -->
                <div class="bg-white p-5 rounded-xl shadow-sm space-y-4">
                    <div>
                        <label class="text-xs font-bold text-gray-500">åç§° <span class="text-red-500">*</span></label>
                        <input v-model="formData.name" type="text" class="w-full mt-1 p-2 bg-gray-50 border-b-2 border-transparent focus:border-theme outline-none" placeholder="è¾“å…¥åç§°">
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-xs font-bold text-gray-500">å“ç‰Œ</label>
                            <div class="relative mt-1">
                                <input v-model="formData.brand" type="text" class="w-full p-2 pr-8 bg-gray-50 rounded text-sm" placeholder="è¾“å…¥æˆ–é€‰æ‹©">
                                <button @click="openSheet('brands', 'brand', 'é€‰æ‹©å“ç‰Œ')" class="absolute right-0 top-0 h-full px-2 text-gray-400 active:text-theme flex items-center justify-center">
                                    <i class="fas fa-chevron-down text-xs"></i>
                                </button>
                            </div>
                        </div>
                        <div>
                            <label class="text-xs font-bold text-gray-500">é¢œè‰²</label>
                            <div class="relative mt-1">
                                <input v-model="formData.color" type="text" class="w-full p-2 pr-8 bg-gray-50 rounded text-sm" placeholder="è¾“å…¥æˆ–é€‰æ‹©">
                                <button @click="openSheet('colors', 'color', 'é€‰æ‹©é¢œè‰²')" class="absolute right-0 top-0 h-full px-2 text-gray-400 active:text-theme flex items-center justify-center">
                                    <i class="fas fa-chevron-down text-xs"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div>
                        <label class="text-xs font-bold text-gray-500">æˆåˆ† <span class="text-red-500">*</span></label>
                        <div class="flex gap-2 mt-1">
                            <button @click="openSheet('materials', 'composition_append', 'æ·»åŠ æˆåˆ†')" class="whitespace-nowrap px-3 bg-gray-100 rounded text-sm text-gray-600 active:bg-gray-200 border border-gray-200">
                                + é€‰æˆåˆ†
                            </button>
                            <input v-model="formData.composition" type="text" class="flex-1 p-2 bg-gray-50 rounded text-sm" placeholder="å¦‚: 80%ç¾Šæ¯› + 20%ç¾Šç»’">
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-xs font-bold text-gray-500">æ€»é‡é‡(g) <span class="text-red-500">*</span></label>
                            <input v-model.number="formData.weight" type="number" class="w-full mt-1 p-2 bg-gray-50 rounded font-mono">
                        </div>
                        <div>
                            <label class="text-xs font-bold text-gray-500">æ€»ä»·æ ¼(å…ƒ) <span class="text-red-500">*</span></label>
                            <input v-model.number="formData.price" type="number" class="w-full mt-1 p-2 bg-gray-50 rounded font-mono">
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-xs font-bold text-gray-500">æ”¯æ•°</label>
                            <div class="relative mt-1">
                                <input v-model="formData.ply" type="text" class="w-full p-2 pr-8 bg-gray-50 rounded text-sm" placeholder="å¦‚ 2/26">
                                <button @click="openSheet('plies', 'ply', 'é€‰æ‹©æ”¯æ•°')" class="absolute right-0 top-0 h-full px-2 text-gray-400 active:text-theme flex items-center justify-center">
                                    <i class="fas fa-chevron-down text-xs"></i>
                                </button>
                            </div>
                        </div>
                        <div>
                            <label class="text-xs font-bold text-gray-500">æ¥æº</label>
                            <div class="relative mt-1">
                                <input v-model="formData.source" type="text" class="w-full p-2 pr-8 bg-gray-50 rounded text-sm" placeholder="å¦‚ æŸå®xxåº—">
                                <button @click="openSheet('sources', 'source', 'é€‰æ‹©æ¥æº')" class="absolute right-0 top-0 h-full px-2 text-gray-400 active:text-theme flex items-center justify-center">
                                    <i class="fas fa-chevron-down text-xs"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-xs font-bold text-gray-500">è´­ä¹°æ—¶é—´</label>
                            <input v-model="formData.buyDate" type="date" class="w-full mt-1 p-2 bg-gray-50 rounded text-sm">
                        </div>
                        <div>
                            <label class="text-xs font-bold text-gray-500">å·²æ¶ˆè€—(g)</label>
                            <input v-model.number="formData.consumed" type="number" class="w-full mt-1 p-2 bg-gray-50 rounded font-mono">
                        </div>
                    </div>
                </div>
            </div>

            <!-- 3. è¯¦æƒ…é¡µ -->
            <div v-if="currentPage === 'detail' && selectedYarn" class="space-y-4">
                <div class="relative bg-black rounded-2xl overflow-hidden shadow-sm" style="min-height: 280px;">
                    <div class="flex overflow-x-auto hide-scrollbar snap-x snap-mandatory" style="height: 300px;">
                         <div v-if="!selectedYarn.images || selectedYarn.images.length === 0" class="w-full flex-shrink-0 flex items-center justify-center bg-gray-200 h-full text-gray-400">
                             æ— å›¾ç‰‡
                         </div>
                         <div v-for="(img, idx) in selectedYarn.images" :key="idx" class="w-full flex-shrink-0 snap-center h-full relative">
                             <img :src="img" class="w-full h-full object-contain bg-black/90">
                             <div class="absolute bottom-4 right-4 bg-black/50 text-white px-2 py-1 rounded-full text-xs">
                                 {{ idx + 1 }} / {{ selectedYarn.images.length }}
                             </div>
                         </div>
                    </div>
                    <button @click="toggleFavorite(selectedYarn)" class="absolute bottom-[-20px] right-6 w-12 h-12 bg-white rounded-full shadow-lg flex items-center justify-center text-xl z-10" style="bottom: 10px;">
                        <i :class="['fas fa-heart', selectedYarn.isFavorite ? 'text-red-500' : 'text-gray-300']"></i>
                    </button>
                </div>
                <div class="text-center text-xs text-gray-400" v-if="selectedYarn.images && selectedYarn.images.length > 1">
                    <i class="fas fa-arrow-left mr-1"></i> å·¦å³æ»‘åŠ¨æŸ¥çœ‹æ›´å¤šå›¾ç‰‡ <i class="fas fa-arrow-right ml-1"></i>
                </div>

                <div class="bg-white pt-6 pb-6 px-6 rounded-2xl shadow-sm relative z-0">
                    <h2 class="text-2xl font-bold text-gray-800">{{ selectedYarn.name }}</h2>
                    <p class="text-sm text-gray-500 mt-1">{{ selectedYarn.composition }}</p>

                    <div class="flex items-center gap-4 mt-4 mb-6">
                        <div class="flex-1 bg-gray-50 p-3 rounded-xl text-center">
                            <div class="text-xs text-gray-400">å‰©ä½™é‡é‡</div>
                            <div class="text-xl font-bold text-theme">{{ selectedYarn.weight - (selectedYarn.consumed || 0) }}g</div>
                        </div>
                        <div class="flex-1 bg-gray-50 p-3 rounded-xl text-center">
                            <div class="text-xs text-gray-400">å•ä»·</div>
                            <div class="text-xl font-bold text-gray-700">Â¥{{ (selectedYarn.price / (selectedYarn.weight/500)).toFixed(0) }}</div>
                        </div>
                    </div>
                    <div class="space-y-3 text-sm">
                        <div class="flex border-b border-gray-100 pb-2"><span class="text-gray-400 w-20">å“ç‰Œ</span><span class="text-gray-800">{{ selectedYarn.brand || '-' }}</span></div>
                        <div class="flex border-b border-gray-100 pb-2"><span class="text-gray-400 w-20">é¢œè‰²</span><span class="text-gray-800">{{ selectedYarn.color || '-' }}</span></div>
                        <div class="flex border-b border-gray-100 pb-2"><span class="text-gray-400 w-20">æ”¯æ•°</span><span class="text-gray-800">{{ selectedYarn.ply || '-' }}</span></div>
                        <div class="flex border-b border-gray-100 pb-2"><span class="text-gray-400 w-20">æ¥æº</span><span class="text-gray-800">{{ selectedYarn.source || '-' }}</span></div>
                        <div class="flex border-b border-gray-100 pb-2"><span class="text-gray-400 w-20">è´­ä¹°æ—¥æœŸ</span><span class="text-gray-800">{{ selectedYarn.buyDate || '-' }}</span></div>
                    </div>
                </div>
                <button @click="confirmDelete(selectedYarn)" class="w-full py-3 text-red-500 bg-white border border-red-100 rounded-xl font-bold active:bg-red-50">åˆ é™¤è®°å½•</button>
            </div>

            <!-- 4. è®¾ç½® -->
            <div v-if="currentPage === 'settings'" class="space-y-5">
                <div class="bg-white p-5 rounded-xl shadow-sm">
                    <h3 class="font-bold text-gray-700 mb-4 flex items-center"><i class="fas fa-palette mr-2 text-theme"></i> ä¸»é¢˜é¢œè‰²</h3>
                    <div class="flex justify-between px-2">
                        <button v-for="c in ['pink','blue','purple','orange','gray']" :key="c" @click="theme = c" class="w-10 h-10 rounded-full ring-2 ring-offset-2 transition-all" :style="{backgroundColor: themeMap[c].primary}" :class="theme===c?'ring-gray-400 scale-110':'ring-transparent'"></button>
                    </div>
                </div>
                <div class="bg-white p-5 rounded-xl shadow-sm">
                    <h3 class="font-bold text-gray-700 mb-4 flex items-center"><i class="fas fa-list-ul mr-2 text-theme"></i> é€‰é¡¹ç®¡ç†</h3>
                    <div class="space-y-3">
                        <button v-for="(v, k) in {brands:'å“ç‰Œ', materials:'æˆåˆ†', colors:'é¢œè‰²', plies:'æ”¯æ•°', sources:'æ¥æº'}" :key="k" @click="openOptionManager(k, v)" class="w-full flex justify-between items-center p-3 bg-gray-50 rounded-lg hover:bg-gray-100">
                            <span>{{v}}ç®¡ç†</span> <i class="fas fa-chevron-right text-gray-400"></i>
                        </button>
                    </div>
                </div>
                <div class="bg-white p-5 rounded-xl shadow-sm">
                    <h3 class="font-bold text-gray-700 mb-4 flex items-center"><i class="fas fa-database mr-2 text-theme"></i> æ•°æ®å¤‡ä»½ (JSONæ ¼å¼)</h3>
                    <div class="flex gap-3">
                        <button @click="exportData" class="flex-1 bg-green-500 text-white py-3 rounded-xl flex items-center justify-center gap-2 shadow-sm active:bg-green-600 transition-colors">
                            <i class="fas fa-file-export"></i> å¯¼å‡ºå¤‡ä»½
                        </button>
                        <div class="flex-1 relative">
                             <button class="w-full bg-blue-500 text-white py-3 rounded-xl flex items-center justify-center gap-2 shadow-sm active:bg-blue-600 transition-colors">
                                <i class="fas fa-file-import"></i> æ¢å¤å¤‡ä»½
                             </button>
                             <input type="file" @change="importData" accept=".json" class="absolute top-0 left-0 w-full h-full opacity-0">
                        </div>
                    </div>
                    <div class="bg-blue-50 text-blue-700 text-xs p-3 rounded-lg mt-3 leading-5 border border-blue-100">
                        <p class="font-bold mb-1">ğŸ’¡ æ€§èƒ½ä¼˜åŒ–ç‰ˆ</p>
                        <p>å·²å¯ç”¨é«˜æ€§èƒ½å­˜å‚¨å¼•æ“ï¼Œæ”¯æŒå­˜å‚¨æ•°ç™¾å¼ ç…§ç‰‡è€Œä¸å¡é¡¿ã€‚</p>
                        <p class="mt-1 text-gray-500">æ³¨æ„ï¼šæ›´æ¢æ‰‹æœºæˆ–æ¸…ç†æµè§ˆå™¨ç¼“å­˜æ—¶ï¼Œè¯·åŠ¡å¿…å…ˆâ€œå¯¼å‡ºå¤‡ä»½â€ã€‚</p>
                    </div>
                </div>
                <div class="text-center text-gray-400 text-xs pt-4">æˆ‘çš„æ¯›çº¿ä»“åº“ v3.3 (é«˜æ€§èƒ½å­˜å‚¨ç‰ˆ)</div>
            </div>
        </main>

        <button v-if="currentPage === 'home'" @click="openAddForm" 
            class="fixed right-6 w-14 h-14 bg-theme text-white rounded-full shadow-lg shadow-gray-400/50 flex items-center justify-center text-2xl z-30 transition-transform active:scale-95"
            style="bottom: calc(4.5rem + env(safe-area-inset-bottom));">
            <i class="fas fa-plus"></i>
        </button>

        <nav class="nav-fixed border-t border-gray-200">
            <div class="flex w-full h-12 items-center">
                <button @click="currentPage = 'home'" class="flex-1 flex flex-col items-center justify-center gap-0.5 transition-colors h-full" :class="currentPage!=='settings' ? 'text-theme' : 'text-gray-400'">
                    <i class="fas fa-home text-xl"></i><span class="text-[10px] font-medium">ä»“åº“</span>
                </button>
                <button @click="currentPage = 'settings'" class="flex-1 flex flex-col items-center justify-center gap-0.5 transition-colors h-full" :class="currentPage==='settings' ? 'text-theme' : 'text-gray-400'">
                    <i class="fas fa-cog text-xl"></i><span class="text-[10px] font-medium">è®¾ç½®</span>
                </button>
            </div>
        </nav>

        <!-- è®¾ç½®é¡µé¢ç”¨çš„æ—§ç‰ˆç®¡ç†å¼¹çª— -->
        <div v-if="showOptionModal" class="modal-mask" @click.self="showOptionModal = false">
            <div class="bg-white w-4/5 max-w-sm rounded-xl p-5 shadow-2xl">
                <div class="flex justify-between items-center mb-4 border-b pb-2"><h3 class="font-bold text-gray-800">ç®¡ç†ï¼š{{ editingOptionTitle }}</h3><button @click="showOptionModal = false" class="text-gray-400"><i class="fas fa-times"></i></button></div>
                <div class="flex gap-2 mb-4"><input v-model="newOptionInput" type="text" class="flex-1 border rounded p-2 text-sm" placeholder="æ–°é€‰é¡¹"><button @click="addOption" class="bg-theme text-white px-4 rounded text-sm">æ·»åŠ </button></div>
                <div class="max-h-60 overflow-y-auto space-y-2 pr-1"><div v-for="(item, index) in options[editingOptionKey]" :key="index" class="flex justify-between items-center bg-gray-50 p-2 rounded text-sm group"><span>{{ item }}</span><button @click="removeOption(index)" class="text-gray-300 hover:text-red-500"><i class="fas fa-trash-alt"></i></button></div></div>
            </div>
        </div>

        <!-- iOSé£æ ¼åº•éƒ¨é€‰æ‹©æŠ½å±‰ -->
        <div v-if="sheet.show" class="bottom-sheet-mask" @click.self="sheet.show = false">
            <div class="bottom-sheet-content">
                <div class="flex justify-between items-center p-4 border-b border-gray-100">
                    <span class="font-bold text-gray-700">{{ sheet.title }}</span>
                    <button @click="sheet.show = false" class="text-gray-400 w-8 h-8 bg-gray-100 rounded-full"><i class="fas fa-times"></i></button>
                </div>
                <div class="overflow-y-auto p-4 space-y-2" style="max-height: 50vh;">
                    <!-- æ˜¾ç¤ºç°æœ‰é€‰é¡¹ -->
                    <div class="flex flex-wrap gap-2">
                        <button v-for="item in options[sheet.listKey]" :key="item" 
                            @click="selectFromSheet(item)"
                            class="px-4 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm text-gray-700 active:bg-theme active:text-white active:border-theme transition-colors">
                            {{ item }}
                        </button>
                    </div>
                    <div v-if="options[sheet.listKey].length === 0" class="text-center text-gray-400 py-4 text-sm">
                        æš‚æ— é€‰é¡¹ï¼Œè¯·ç›´æ¥åœ¨è¾“å…¥æ¡†è¾“å…¥ï¼Œä¿å­˜åä¼šè‡ªåŠ¨è®°å½•ã€‚
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<script>
    const { createApp, ref, computed, reactive, watch, onMounted } = Vue;

    createApp({
        setup() {
            const isLoading = ref(true); // é»˜è®¤åŠ è½½ä¸­ï¼Œç›´åˆ°ä» IndexedDB è¯»å–å®Œæ¯•
            const loadingText = ref('åŠ è½½ä»“åº“æ•°æ®...');

            // åˆå§‹åŒ– LocalForage
            localforage.config({
                driver: localforage.INDEXEDDB, // å¼ºåˆ¶ä½¿ç”¨ IndexedDB
                name: 'YarnStockApp',
                version: 1.0,
                storeName: 'yarn_data'
            });

            // --- æ ¸å¿ƒçŠ¶æ€ ---
            const theme = ref(localStorage.getItem('coil_theme') || 'pink');
            const themeMap = {
                pink: { primary: '#fb7185', bgLight: '#fff1f2', text: '#881337' },
                blue: { primary: '#2dd4bf', bgLight: '#f0fdfa', text: '#134e4a' },
                purple: { primary: '#c084fc', bgLight: '#faf5ff', text: '#581c87' },
                gray: { primary: '#6b7280', bgLight: '#f3f4f6', text: '#111827' },
                orange: { primary: '#fbbf24', bgLight: '#fffbeb', text: '#78350f' }
            };

            const currentPage = ref('home');
            const yarns = ref([]);
            
            // é€‰é¡¹æ•°æ®
            const defaultOptions = {
                materials: ['ç¾Šæ¯›', 'ç¾Šç»’', 'è²‰ç»’', 'é©¬æµ·', 'åŒ–çº¤', 'çœŸä¸', 'è‹éº»', 'æ£‰', 'æ··çºº'],
                brands: ['è´è¶', 'å‡Œå‰', 'åº·èµ›å¦®', 'ä¸­é¼', 'æ–°å¥¥', 'æ¬§ç¾æ–¯', 'å—éŸ©'],
                plies: ['2/26', '2/28', '2/30', '1/4', '1/16', '1/15'],
                colors: ['çº¢', 'ç™½', 'è“', 'ç»¿', 'é»‘', 'ç´«', 'æ£•', 'å’–', 'ç°'],
                sources: ['ç™¾ç™¾', 'è€å¸¸', 'å‚»å°å­', 'æ„è¾¾']
            };
            const options = reactive(JSON.parse(localStorage.getItem('coil_options')) || defaultOptions);
            
            // åº•éƒ¨æŠ½å±‰çŠ¶æ€
            const sheet = reactive({ show: false, listKey: '', targetField: '', title: '' });

            const filterType = ref('all');
            const sortBy = ref('dateDesc');
            const selectedYarn = ref(null);
            const isEditing = ref(false);

            const formData = reactive({
                id: null, name: '', images: [], brand: '', color: '', composition: '',
                weight: 500, price: 0, ply: '', source: '', buyDate: '', consumed: 0,
                isFavorite: false, createTime: 0
            });

            // æ—§ç‰ˆå¼¹çª—çŠ¶æ€
            const showOptionModal = ref(false);
            const editingOptionKey = ref('');
            const editingOptionTitle = ref('');
            const newOptionInput = ref('');

            // --- ç›‘å¬ä¸åˆå§‹åŒ– ---
            watch(theme, (newVal) => {
                const t = themeMap[newVal] || themeMap['pink'];
                document.documentElement.style.setProperty('--primary', t.primary);
                document.documentElement.style.setProperty('--bg-light', t.bgLight);
                document.documentElement.style.setProperty('--text-theme', t.text);
                localStorage.setItem('coil_theme', newVal);
            }, { immediate: true });

            // å…³é”®ä¿®æ”¹ï¼šåˆå§‹åŒ–æ—¶å°è¯•ä» LocalStorage è¿ç§»æ•°æ®ï¼Œç„¶åè¯»å– IndexedDB
            onMounted(async () => {
                try {
                    // 1. å°è¯•è¯»å– IndexedDB æ•°æ®
                    const dbYarns = await localforage.getItem('coil_yarns');
                    
                    if (dbYarns) {
                        yarns.value = dbYarns;
                    } else {
                        // 2. å¦‚æœ IndexedDB ä¸ºç©ºï¼Œæ£€æŸ¥æ˜¯å¦æœ‰æ—§çš„ LocalStorage æ•°æ®ï¼ˆè¿ç§»é€»è¾‘ï¼‰
                        const oldYarns = localStorage.getItem('coil_yarns');
                        if (oldYarns) {
                            console.log('æ­£åœ¨ä»æ—§ç‰ˆ LocalStorage è¿ç§»æ•°æ®...');
                            let parsed = JSON.parse(oldYarns);
                            parsed.forEach(y => { if (!y.images) y.images = y.image ? [y.image] : []; });
                            yarns.value = parsed;
                            // å­˜å…¥ IndexedDB
                            await localforage.setItem('coil_yarns', parsed);
                            // æ¸…é™¤æ—§æ•°æ®é‡Šæ”¾ç©ºé—´ (å¯é€‰ï¼Œä¸ºäº†å®‰å…¨æš‚ä¿ç•™)
                            // localStorage.removeItem('coil_yarns'); 
                        }
                    }
                    
                    // é€‰é¡¹æ•°æ®é‡å°ï¼Œä¿ç•™åœ¨ LocalStorage å³å¯
                    for(let key in defaultOptions) if(!options[key]) options[key] = defaultOptions[key];
                } catch (err) {
                    console.error("åŠ è½½æ•°æ®å¤±è´¥:", err);
                    alert("æ•°æ®åŠ è½½å‡ºç°é—®é¢˜ï¼Œè¯·åˆ·æ–°é‡è¯•");
                } finally {
                    isLoading.value = false;
                }
            });

            // å…³é”®ä¿®æ”¹ï¼šç§»é™¤å¯¹ yarns çš„è‡ªåŠ¨ watchï¼Œé¿å…é¢‘ç¹å†™å…¥ç¡¬ç›˜å¯¼è‡´å¡é¡¿
            // watch(yarns, ...) å·²åˆ é™¤ã€‚
            
            watch(options, () => localStorage.setItem('coil_options', JSON.stringify(options)), { deep: true });

            // å°è£…ä¿å­˜å‡½æ•°
            const persistData = async () => {
                try {
                    // æ·±æ‹·è´ä»¥å»é™¤ Proxy
                    const dataToSave = JSON.parse(JSON.stringify(yarns.value));
                    await localforage.setItem('coil_yarns', dataToSave);
                } catch (err) {
                    console.error("ä¿å­˜å¤±è´¥:", err);
                    alert("ä¿å­˜å¤±è´¥ï¼Œå­˜å‚¨ç©ºé—´å¯èƒ½ä¸è¶³");
                }
            };

            // --- è®¡ç®—å±æ€§ ---
            const pageTitle = computed(() => ({ home: 'æˆ‘çš„æ¯›çº¿ä»“åº“', settings: 'è®¾ç½®', form: isEditing.value ? 'ç¼–è¾‘è®°å½•' : 'å…¥åº“ç™»è®°', detail: 'è¯¦æƒ…' }[currentPage.value]));
            const totalCost = computed(() => yarns.value.reduce((sum, y) => sum + (y.price || 0), 0));
            const totalWeight = computed(() => yarns.value.reduce((sum, y) => sum + (y.weight || 0), 0));
            const totalConsumed = computed(() => yarns.value.reduce((sum, y) => sum + (y.consumed || 0), 0));
            
            const filteredYarns = computed(() => {
                let list = [...yarns.value];
                if (filterType.value === 'fav') list = list.filter(y => y.isFavorite);
                list.sort((a, b) => {
                    if (sortBy.value === 'dateDesc') return b.createTime - a.createTime;
                    if (sortBy.value === 'priceDesc') return (b.price/b.weight) - (a.price/a.weight);
                    if (sortBy.value === 'weightDesc') return (b.weight - (b.consumed||0)) - (a.weight - (a.consumed||0));
                    return 0;
                });
                return list;
            });

            // --- æ–¹æ³• ---
            const goBack = () => currentPage.value = 'home';
            
            // åº•éƒ¨æŠ½å±‰é€»è¾‘
            const openSheet = (listKey, targetField, title) => {
                sheet.listKey = listKey;
                sheet.targetField = targetField;
                sheet.title = title;
                sheet.show = true;
            };

            const selectFromSheet = (value) => {
                if (sheet.targetField === 'composition_append') {
                    formData.composition = formData.composition ? `${formData.composition} + ${value}` : value;
                } else {
                    formData[sheet.targetField] = value;
                }
                sheet.show = false;
            };

            // è®¾ç½®é¡µçš„ç®¡ç†é€»è¾‘
            const openOptionManager = (k, t) => { editingOptionKey.value = k; editingOptionTitle.value = t; newOptionInput.value = ''; showOptionModal.value = true; };
            const addOption = () => { if(newOptionInput.value.trim()){ options[editingOptionKey.value].push(newOptionInput.value.trim()); newOptionInput.value = ''; }};
            const removeOption = (i) => options[editingOptionKey.value].splice(i, 1);

            // å›¾ç‰‡å¤„ç† - ä¿æŒå‹ç¼©
            const handleImageUpload = (e) => {
                const files = e.target.files;
                if (!files.length) return;
                isLoading.value = true;
                loadingText.value = 'å¤„ç†ç…§ç‰‡ä¸­...';
                setTimeout(() => {
                    const maxProcess = 5;
                    const count = Math.min(files.length, maxProcess);
                    let processed = 0;
                    for (let i = 0; i < count; i++) {
                        const reader = new FileReader();
                        reader.onload = (evt) => {
                            const img = new Image();
                            img.onload = () => {
                                const canvas = document.createElement('canvas');
                                const ctx = canvas.getContext('2d');
                                const maxWidth = 500; // ä¿æŒ 500px ä»¥æ§åˆ¶å¤§å°
                                const scale = maxWidth / img.width;
                                canvas.width = maxWidth;
                                canvas.height = img.height * scale;
                                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                                // 0.6 è´¨é‡å‹ç¼©
                                formData.images.push(canvas.toDataURL('image/jpeg', 0.6));
                                processed++;
                                if(processed === count) isLoading.value = false;
                            };
                            img.src = evt.target.result;
                        };
                        reader.readAsDataURL(files[i]);
                    }
                }, 50);
            };
            const removeImage = (index) => { formData.images.splice(index, 1); };

            // è¡¨å•æ“ä½œ
            const openAddForm = () => {
                isEditing.value = false;
                Object.keys(formData).forEach(k => formData[k] = (k==='weight'?500:k==='price'?0:k==='consumed'?0:k==='isFavorite'?false:k==='images'?[]:''));
                formData.buyDate = new Date().toISOString().split('T')[0];
                currentPage.value = 'form';
            };

            const editYarn = (yarn) => {
                isEditing.value = true;
                const data = JSON.parse(JSON.stringify(yarn));
                if (!data.images) data.images = data.image ? [data.image] : [];
                Object.assign(formData, data);
                currentPage.value = 'form';
            };

            // ä¿å­˜é€»è¾‘ä¼˜åŒ–
            const saveYarn = async () => {
                if (!formData.name || !formData.weight) return alert('è¯·å¡«å†™åç§°å’Œé‡é‡');
                
                isLoading.value = true;
                loadingText.value = 'æ­£åœ¨ä¿å­˜...';

                // è‡ªåŠ¨ä¿å­˜æ–°é€‰é¡¹é€»è¾‘
                const checkAndSave = (fieldValue, listKey) => {
                    if (fieldValue && fieldValue.trim()) {
                        const val = fieldValue.trim();
                        if (!options[listKey].includes(val)) {
                            options[listKey].push(val);
                        }
                    }
                };
                checkAndSave(formData.brand, 'brands');
                checkAndSave(formData.color, 'colors');
                checkAndSave(formData.ply, 'plies');
                checkAndSave(formData.source, 'sources');

                const data = { ...formData };
                data.image = data.images.length > 0 ? data.images[0] : '';
                
                if (isEditing.value) {
                    const idx = yarns.value.findIndex(y => y.id === formData.id);
                    if (idx !== -1) {
                        yarns.value[idx] = data;
                        selectedYarn.value = data;
                        currentPage.value = 'detail';
                    }
                } else {
                    data.id = Date.now().toString(36) + Math.random().toString(36).substr(2);
                    data.createTime = Date.now();
                    yarns.value.unshift(data);
                    currentPage.value = 'home';
                }

                // æ˜¾å¼å¼‚æ­¥ä¿å­˜
                await persistData();
                isLoading.value = false;
            };

            const viewDetail = (y) => { selectedYarn.value = y; currentPage.value = 'detail'; };
            
            const toggleFavorite = async (y) => { 
                y.isFavorite = !y.isFavorite;
                await persistData(); // ç‚¹å‡»æ”¶è—åæ‰‹åŠ¨ä¿å­˜
            };
            
            const confirmDelete = async (y) => { 
                if (confirm('ç¡®å®šåˆ é™¤å—ï¼Ÿ')) { 
                    yarns.value = yarns.value.filter(item => item.id !== y.id); 
                    currentPage.value = 'home'; 
                    await persistData(); // åˆ é™¤åæ‰‹åŠ¨ä¿å­˜
                }
            };

            // æ•°æ®å¤‡ä»½
            const exportData = () => {
                const nameInput = prompt("è¯·è¾“å…¥å¤‡ä»½æ–‡ä»¶å:", "æ¯›çº¿åº“å­˜å¤‡ä»½_" + new Date().toISOString().split('T')[0]);
                if (!nameInput) return;
                isLoading.value = true;
                loadingText.value = 'æ­£åœ¨ç”Ÿæˆå¤‡ä»½æ–‡ä»¶...';
                
                setTimeout(() => {
                    try {
                        const jsonStr = JSON.stringify(yarns.value);
                        const blob = new Blob([jsonStr], { type: 'application/json' });
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement("a");
                        a.href = url;
                        a.download = nameInput + ".json";
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        window.URL.revokeObjectURL(url);
                        setTimeout(() => { alert("å¤‡ä»½å·²ç”Ÿæˆï¼\nè¯·ä¿å­˜å¥½è¯¥ JSON æ–‡ä»¶ã€‚"); }, 500);
                    } catch (e) { alert("å¤‡ä»½å¤±è´¥ï¼š" + e.message); } finally { isLoading.value = false; }
                }, 100);
            };

            const importData = (e) => {
                const file = e.target.files[0];
                if(!file) return;
                isLoading.value = true;
                loadingText.value = 'æ­£åœ¨æ¢å¤æ•°æ®...';
                setTimeout(() => {
                    const reader = new FileReader();
                    reader.onload = async (evt) => {
                        try {
                            const importedYarns = JSON.parse(evt.target.result);
                            if (!Array.isArray(importedYarns)) throw new Error("æ ¼å¼é”™è¯¯");
                            let added = 0, updated = 0;
                            importedYarns.forEach(item => {
                                if (!item.id || !item.name) return;
                                const existIdx = yarns.value.findIndex(y => y.id === item.id);
                                if(existIdx > -1) { yarns.value[existIdx] = { ...item, isFavorite: yarns.value[existIdx].isFavorite }; updated++; } 
                                else { yarns.value.unshift(item); added++; }
                            });
                            await persistData(); // å¯¼å…¥åä¿å­˜
                            alert(`æ¢å¤æˆåŠŸï¼šæ–°å¢ ${added} æ¡, æ›´æ–° ${updated} æ¡`);
                        } catch (err) { alert("æ¢å¤å¤±è´¥ï¼šæ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®æˆ–å·²æŸå"); } finally { isLoading.value = false; e.target.value = ''; }
                    };
                    reader.readAsText(file);
                }, 100);
            };

            return {
                isLoading, loadingText,
                currentPage, theme, yarns, filterType, sortBy, selectedYarn, formData, options,
                sheet, openSheet, selectFromSheet, 
                showOptionModal, editingOptionTitle, editingOptionKey, newOptionInput,
                themeMap, pageTitle, totalCost, totalWeight, totalConsumed, filteredYarns, isEditing,
                goBack, openAddForm, editYarn, saveYarn, handleImageUpload, removeImage,
                viewDetail, toggleFavorite, confirmDelete, exportData, importData,
                openOptionManager, addOption, removeOption
            };
        }
    }).mount('#app');
</script>
</body>
</html>
